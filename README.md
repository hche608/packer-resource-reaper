# AWS Packer Resource Reaper

A serverless application that automatically identifies and cleans up "zombie" EC2 instances and associated resources left behind by failed or interrupted Packer builds. The system operates as an external watchdog within a single AWS account and region, providing a simple, stateless cleanup mechanism.

## ⚠️ Important Warning

**Instances are detected by the name of the SSH key that is automatically generated by Packer (pattern: `packer_*`).** 

**Do NOT use this application if you use similar key naming patterns** (e.g., `packer_mykey`, `packer_production`) for non-Packer instances, as they may be incorrectly identified and terminated.

## Features

- **Two-Criteria Filtering**: Instances must match BOTH key pair pattern (`packer_*`) AND age threshold
- **Safety-First Filtering**: Explicit name checks for orphaned resources (Security Groups, Key Pairs) to prevent accidental production deletion
- **Dependency-Aware Cleanup**: Terminates instances before deleting dependent resources
- **Dry-Run Mode**: Test cleanup behavior without executing destructive operations
- **SNS Notifications**: Notifications for all cleanup actions with resource details
- **Stateless Architecture**: No database required; fresh scan on every execution
- **Single Account/Region Scope**: Operates strictly within the deployed AWS account and region

## Table of Contents

- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Configuration](#configuration)
- [Deployment](#deployment)
- [IAM Permissions](#iam-permissions)
- [Monitoring and Logging](#monitoring-and-logging)
- [Troubleshooting](#troubleshooting)
- [Development](#development)

## Prerequisites

- **AWS CLI** v2.x configured with appropriate credentials
- **AWS SAM CLI** v1.x for deployment
- **Python** 3.11 or later
- **uv** package manager (recommended) or pip

### Installing AWS SAM CLI

```bash
# macOS (using Homebrew)
brew install aws-sam-cli

# Linux
pip install aws-sam-cli

# Verify installation
sam --version
```

### Installing uv (Recommended)

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

## Quick Start

1. **Clone and set up the project**:
   ```bash
   git clone <repository-url>
   cd packer-resource-reaper
   make install-dev
   ```

2. **Build and deploy in dry-run mode** (recommended for first deployment):
   ```bash
   make build
   sam deploy --guided
   ```

3. **Verify deployment**:
   ```bash
   # Check Lambda function
   aws lambda get-function --function-name packer-resource-reaper-function

   # Manually invoke in dry-run mode
   aws lambda invoke --function-name packer-resource-reaper-function output.json
   cat output.json
   ```

## Configuration

### Environment Variables

The reaper is configured via environment variables set in the SAM template:

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `MAX_INSTANCE_AGE_HOURS` | Maximum age (hours) before an instance is considered for cleanup | `2` | No |
| `DRY_RUN` | Enable dry-run mode (`true`/`false`) | `true` | No |
| `NOTIFICATION_TOPIC_ARN` | SNS topic ARN for notifications (also supports `SNS_TOPIC_ARN`) | Auto-created | No |
| `KEY_PAIR_PATTERN` | Prefix pattern for identifying Packer resources | `packer_` | No |
| `LOG_LEVEL` | Logging level (`DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`) | `INFO` | No |
| `BATCH_DELETE_SIZE` | Number of resources to delete concurrently per batch | `1` | No |

> Note: `AWS_REGION` is automatically detected from the Lambda runtime environment.

### SAM Template Parameters

When deploying with `sam deploy --guided`, you'll be prompted for these parameters:

| Parameter | Description | Default | Allowed Values |
|-----------|-------------|---------|----------------|
| `MaxInstanceAgeHours` | Maximum instance age in hours | `2` | 1-168 |
| `DryRun` | Enable dry-run mode | `true` | `true`, `false` |
| `ScheduleExpression` | EventBridge schedule | `rate(1 hour)` | Any valid schedule expression |
| `NotificationEmail` | Email for notifications | (empty) | Valid email address |
| `LogLevel` | Logging verbosity | `INFO` | `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL` |
| `BatchDeleteSize` | Resources to delete per batch | `1` | 1-50 |
| `KeyPairPattern` | Prefix pattern for Packer key pairs | `packer_` | Any string |
| `LogRetentionDays` | CloudWatch log retention | `30` | 1, 3, 5, 7, 14, 30, 60, 90, etc. |

### Configuration Examples

#### Basic Setup (Dry-Run Mode)
```bash
sam deploy \
  --stack-name packer-reaper \
  --parameter-overrides \
    MaxInstanceAgeHours=2 \
    DryRun=true \
    NotificationEmail=devops@example.com
```

#### Production Setup (Live Mode)
```bash
sam deploy \
  --stack-name packer-reaper \
  --parameter-overrides \
    MaxInstanceAgeHours=4 \
    DryRun=false \
    ScheduleExpression="rate(30 minutes)" \
    NotificationEmail=devops@example.com
```

#### Using samconfig.toml

The project includes a `samconfig.toml` with pre-configured environments:

```bash
# Deploy with default settings (dry-run)
make deploy

# Deploy to production (live mode)
make deploy-prod

# Deploy to development (frequent checks)
make deploy-dev

# Or using sam directly:
sam build && sam deploy --config-env prod
```

## Deployment

For detailed deployment instructions, including manual steps and troubleshooting, see DEPLOYMENT.md.

### First-Time Deployment

1. **Build the application**:
   ```bash
   sam build
   ```

2. **Deploy with guided prompts**:
   ```bash
   sam deploy --guided
   ```

   This will prompt you for:
   - Stack name (e.g., `packer-reaper`)
   - AWS Region
   - Parameter values
   - IAM role creation confirmation

3. **Confirm email subscription** (if NotificationEmail was provided):
   - Check your email for an SNS subscription confirmation
   - Click the confirmation link

### Subsequent Deployments

```bash
sam build && sam deploy
```

### Multi-Region Deployment

Deploy to multiple regions for comprehensive coverage:

```bash
# Deploy to us-east-1
sam deploy --stack-name packer-reaper --region us-east-1

# Deploy to us-west-2
sam deploy --stack-name packer-reaper --region us-west-2

# Deploy to eu-west-1
sam deploy --stack-name packer-reaper --region eu-west-1
```

### Transitioning from Dry-Run to Live Mode

**Important**: Always test in dry-run mode first!

1. **Review dry-run logs** in CloudWatch to verify correct resource identification
2. **Update the DRY_RUN parameter**:
   ```bash
   sam deploy --parameter-overrides DryRun=false
   ```
3. **Monitor the first live execution** closely via CloudWatch Logs

## IAM Permissions

### Lambda Execution Role

The SAM template creates an IAM role with least-privilege permissions:

#### EC2 Read Permissions (all resources)
- `ec2:DescribeInstances`
- `ec2:DescribeVolumes`
- `ec2:DescribeSnapshots`
- `ec2:DescribeSecurityGroups`
- `ec2:DescribeKeyPairs`
- `ec2:DescribeAddresses`

#### EC2 Write Permissions (scoped to account/region)
- `ec2:TerminateInstances` - Scoped to account instances
- `ec2:DeleteSecurityGroup` - Scoped to account security groups
- `ec2:DeleteKeyPair` - All key pairs
- `ec2:DeleteVolume` - Scoped to account volumes
- `ec2:DeleteSnapshot` - Scoped to account snapshots
- `ec2:ReleaseAddress` - All addresses

#### Supporting Services
- `sns:Publish` - Scoped to notification topic
- `sts:GetCallerIdentity` - For account ID retrieval
- `logs:CreateLogStream`, `logs:PutLogEvents` - For CloudWatch logging

### Custom IAM Policy (Manual Setup)

If deploying without SAM, create this IAM policy:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "EC2ReadAccess",
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeInstances",
        "ec2:DescribeVolumes",
        "ec2:DescribeSnapshots",
        "ec2:DescribeSecurityGroups",
        "ec2:DescribeKeyPairs",
        "ec2:DescribeAddresses"
      ],
      "Resource": "*"
    },
    {
      "Sid": "EC2CleanupAccess",
      "Effect": "Allow",
      "Action": [
        "ec2:TerminateInstances",
        "ec2:DeleteSecurityGroup",
        "ec2:DeleteVolume",
        "ec2:DeleteSnapshot",
        "ec2:DeleteKeyPair",
        "ec2:ReleaseAddress"
      ],
      "Resource": "*"
    },
    {
      "Sid": "STSAccess",
      "Effect": "Allow",
      "Action": "sts:GetCallerIdentity",
      "Resource": "*"
    }
  ]
}
```

## Monitoring and Logging

### CloudWatch Logs

Logs are stored in `/aws/lambda/<stack-name>-function` with configurable retention.

**View recent logs**:
```bash
aws logs tail /aws/lambda/packer-resource-reaper-function --follow
```

**Search for cleanup actions**:
```bash
aws logs filter-log-events \
  --log-group-name /aws/lambda/packer-resource-reaper-function \
  --filter-pattern "cleanup"
```

### CloudWatch Alarms

The deployment creates alarms for:
- **Error Alarm**: Triggers when Lambda encounters errors
- **Throttle Alarm**: Triggers when Lambda is throttled

**View alarm status**:
```bash
aws cloudwatch describe-alarms --alarm-name-prefix packer-resource-reaper
```

### SNS Notifications

Notifications include:
- Instance ID, type, and termination reason
- List of deleted associated resources (security groups, key pairs, volumes)
- Dry-run simulation reports (when in dry-run mode)

## Troubleshooting

### Common Issues

#### 1. Lambda Times Out

**Symptoms**: Function execution exceeds 5-minute timeout

**Solutions**:
- Check for API throttling in CloudWatch Logs
- Increase Lambda timeout in template.yaml (max 15 minutes)

#### 2. DependencyViolation Errors

**Symptoms**: Security groups or key pairs fail to delete

**Cause**: Resources are still attached to instances in `shutting-down` state

**Solution**: This is expected behavior. The reaper logs the error and continues. The resource will be re-identified and cleaned up in the next execution.

#### 3. Access Denied Errors

**Symptoms**: `AccessDenied` or `UnauthorizedOperation` errors in logs

**Solutions**:
- Verify IAM role has required permissions
- Check that the Lambda is deployed in the correct account/region

```bash
# Check Lambda execution role
aws lambda get-function --function-name packer-resource-reaper-function \
  --query 'Configuration.Role'

# Verify role policies
aws iam list-attached-role-policies --role-name <role-name>
```

#### 4. No Resources Found

**Symptoms**: Reaper runs but finds no resources to clean up

**Checks**:
- Verify `MAX_INSTANCE_AGE_HOURS` is appropriate
- Ensure instances have key pairs matching `packer_*` pattern
- Review filter criteria in logs

```bash
# Check current configuration
aws lambda get-function-configuration \
  --function-name packer-resource-reaper-function \
  --query 'Environment.Variables'
```

#### 5. SNS Notifications Not Received

**Symptoms**: No email notifications despite cleanup actions

**Solutions**:
- Confirm email subscription in SNS console
- Check spam folder for confirmation email
- Verify SNS topic ARN is set correctly

```bash
# List SNS subscriptions
aws sns list-subscriptions-by-topic \
  --topic-arn <topic-arn>
```

### Manual Invocation

Test the reaper manually:

```bash
# Invoke and view response
aws lambda invoke \
  --function-name packer-resource-reaper-function \
  --payload '{}' \
  response.json

cat response.json | jq .
```

## Development

### Local Setup

```bash
# Create virtual environment and install dev dependencies
make install-dev

# Or manually:
uv venv
source .venv/bin/activate  # Linux/macOS
uv pip install -e ".[dev]"
```

### Running Tests

```bash
# Run all tests
make test

# Run with coverage
make test-cov

# Run fast tests (skip property-based tests)
make test-fast

# Run security group safety tests
make test-safety
```

### Code Quality

```bash
# Run all checks (lint + format-check + type-check)
make check

# Format code
make format

# Lint only
make lint

# Type checking (has some boto3 stub warnings)
make type-check
```

### Local Testing with SAM

```bash
# Build
make build

# Validate SAM template
make validate

# Invoke locally (requires Docker)
make invoke
```

### Available Make Targets

```bash
make help  # Show all available targets
```

## Resource Identification Criteria

The reaper identifies Packer resources using these criteria:

### EC2 Instances (Two-Criteria Filter)
1. **Key Pair Pattern**: Launched with key pair matching `packer_*` pattern
2. **Age Threshold**: Age exceeds `MAX_INSTANCE_AGE_HOURS`

Both criteria must be met for an instance to be selected for cleanup.

### Associated Resources (Collected Before Termination)
- **Security Groups**: Associated with identified zombie instances
- **Key Pairs**: Used by identified zombie instances
- **EBS Volumes**: Attached to identified zombie instances
- **Elastic IPs**: Associated with identified zombie instances

## Architecture

```
┌─────────────────┐     ┌─────────────────┐
│   EventBridge   │────▶│  Lambda Function │
│   (Scheduler)   │     │   (Reaper)       │
└─────────────────┘     └────────┬─────────┘
                                 │
                    ┌────────────┼────────────┐
                    │            │            │
                    ▼            ▼            ▼
            ┌───────────┐ ┌───────────┐ ┌───────────┐
            │   EC2     │ │ CloudWatch│ │    SNS    │
            │   API     │ │   Logs    │ │   Topic   │
            └───────────┘ └───────────┘ └───────────┘
```

## License

MIT License - See LICENSE file for details.
